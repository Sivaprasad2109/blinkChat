<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="theme-color" content="#0a3d91">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BlinkChat Room</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="/socket.io/socket.io.js"></script>
  <script src="/crypto-js/crypto-js.js"></script>
</head>

<body class="chat">
  <div class="chat-container">
    <header>
      <h2 id="roomTitle">BlinkChat Room</h2>
      <div style="display:flex;gap:8px;align-items:center">
        <div id="typingIndicator" style="font-size:0.85rem;color:#cfe0ff;display:none">Friend is typingâ€¦</div>
        <button id="quitBtn">Quit</button>
      </div>
    </header>

    <div id="messages" class="messages"></div>

    <div class="input-container">
      <button id="emojiBtn" title="Emoji" style="background:transparent;border:none;font-size:18px;cursor:pointer">ğŸ˜Š</button>
      <input type="text" id="messageInput" placeholder="Type a message..." autocomplete="off" />
      <button id="sendBtn" class="btn">Send</button>
    </div>

    <!-- Emoji Panel -->
    <div id="emojiPanel" style="display:none; position:fixed; bottom:80px; left:20px; background:#fff; border:1px solid #ddd; padding:8px; border-radius:8px; box-shadow:0 8px 20px rgba(0,0,0,0.12);">
      <div style="display:flex;flex-wrap:wrap;gap:8px; width:220px">
        <button class="emoji" style="background:none;border:none;font-size:20px;cursor:pointer">ğŸ˜€</button>
        <button class="emoji" style="background:none;border:none;font-size:20px;cursor:pointer">ğŸ˜‚</button>
        <button class="emoji" style="background:none;border:none;font-size:20px;cursor:pointer">ğŸ˜</button>
        <button class="emoji" style="background:none;border:none;font-size:20px;cursor:pointer">ğŸ˜®</button>
        <button class="emoji" style="background:none;border:none;font-size:20px;cursor:pointer">ğŸ˜¢</button>
        <button class="emoji" style="background:none;border:none;font-size:20px;cursor:pointer">ğŸ‘</button>
        <button class="emoji" style="background:none;border:none;font-size:20px;cursor:pointer">ğŸ™</button>
        <button class="emoji" style="background:none;border:none;font-size:20px;cursor:pointer">ğŸ”¥</button>
      </div>
    </div>
  </div>

  <script>
(() => {
    const socket = io();
    const params = new URLSearchParams(window.location.search);
    const roomId = params.get('room');
    const secretKey = params.get('key');
    const expireAt = params.get('expireAt');

    const messagesDiv = document.getElementById('messages');
    const input = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const quitBtn = document.getElementById('quitBtn');
    const typingIndicator = document.getElementById('typingIndicator');
    const emojiBtn = document.getElementById('emojiBtn');
    const emojiPanel = document.getElementById('emojiPanel');
    const roomTitle = document.getElementById('roomTitle');

    if (!roomId || !secretKey) {
      alert('Room or key missing. Cannot connect securely.');
      window.location.href = '/';
      return;
    }

    if (!window.CryptoJS) {
      alert('Encryption module not loaded. Please refresh.');
      window.location.href = '/';
      return;
    }

    roomTitle.textContent = `Room: ${roomId}`;

    let myName = localStorage.getItem('blinkchat_name') || '';
    if (!myName) {
      myName = prompt('Enter your display name:')?.trim() || 'Anonymous';
      localStorage.setItem('blinkchat_name', myName);
    }

    // JOIN
    socket.emit('joinRoom', { roomId, name: myName });

    // BEEP SOUND
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playBeep(freq = 600, duration = 0.06, volume = 0.02) {
      try {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'sine';
        osc.frequency.value = freq;
        gain.gain.value = volume;
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        setTimeout(() => osc.stop(), duration * 1000);
      } catch {}
    }

    // TYPING
    let typingTimer;
    input.addEventListener('input', () => {
      socket.emit('typing', roomId);
      clearTimeout(typingTimer);
      typingTimer = setTimeout(() => socket.emit('stopTyping', roomId), 1200);
    });

    socket.on('showTyping', () => {
      typingIndicator.style.display = 'block';
      clearTimeout(typingIndicator._hideTimer);
      typingIndicator._hideTimer = setTimeout(() => typingIndicator.style.display = 'none', 1500);
    });

    socket.on('hideTyping', () => typingIndicator.style.display = 'none');

    // EMOJI
    emojiBtn.addEventListener('click', () => {
      emojiPanel.style.display = emojiPanel.style.display === 'none' ? 'block' : 'none';
    });
    emojiPanel.addEventListener('click', e => {
      if (e.target.classList.contains('emoji')) {
        input.value += e.target.textContent;
        input.focus();
      }
    });

    // SEND MESSAGE
    sendBtn.addEventListener('click', sendMessage);
    input.addEventListener('keydown', e => { if (e.key === 'Enter') sendMessage(); });

    function sendMessage() {
      const msg = input.value.trim();
      if (!msg) return;
      const encrypted = CryptoJS.AES.encrypt(msg, secretKey).toString();
      socket.emit('sendMessage', { roomId, message: encrypted });
      addMessage(`${myName} (You)`, msg, 'right');
      playBeep(880, 0.05, 0.02);
      input.value = '';
    }

    // RECEIVE MESSAGE
socket.on('newMessage', ({ message: encrypted, from }) => {
  try {
    const bytes = CryptoJS.AES.decrypt(encrypted, secretKey);
    const decrypted = bytes.toString(CryptoJS.enc.Utf8) || '[Unable to decrypt]';
    addMessage(from || 'Friend', decrypted, 'left');
    playBeep(520, 0.08, 0.02);
  } catch {
    addMessage('System', '[Decryption error]', 'center');
  }
});


    socket.on('systemMessage', txt => addMessage('System', txt, 'center'));

    quitBtn.addEventListener('click', () => {
      if (confirm('Leave chat and delete your name?')) {
        localStorage.removeItem('blinkchat_name');
        socket.emit('quitRoom', roomId);
        window.location.href = '/';
      }
    });

    function addMessage(user, msg, side) {
      const div = document.createElement('div');
      div.classList.add('msg', side);
      const nameTag = (side !== 'center')
        ? `<div style="font-size:0.7rem;color:#3b6aa9;margin-bottom:4px">${escapeHtml(user)}</div>`
        : '';
      div.innerHTML = `${nameTag}<div style="white-space:pre-wrap">${escapeHtml(msg)}</div>`;
      messagesDiv.appendChild(div);
      messagesDiv.scrollTo({ top: messagesDiv.scrollHeight, behavior: 'smooth' });
    }

    function escapeHtml(str) {
      return str.replace(/[&<>"']/g, m =>
        ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])
      );
    }

    // ROOM EXPIRY TIMER (FIXED HERE)
    const expiryTime = new Date(Number(expireAt));
    const countdownDisplay = document.createElement('div');
    countdownDisplay.style.cssText = 'text-align:center;font-size:0.8rem;color:#fff;margin-top:6px;';
    document.querySelector('header').appendChild(countdownDisplay);

    setInterval(() => {
      const diff = expiryTime - Date.now();
      if (diff <= 0) {
        countdownDisplay.textContent = 'Room expired.';
        socket.emit('quitRoom', roomId);
        setTimeout(() => window.location.href = '/', 2000);
      } else {
        const mins = Math.floor(diff / 60000);
        const secs = Math.floor((diff % 60000) / 1000);
        countdownDisplay.textContent = `Expires in ${mins}:${secs < 10 ? '0' : ''}${secs}`;
      }
    }, 1000);

    input.focus();
})();
</script>
</body>
</html>

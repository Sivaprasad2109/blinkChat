<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="theme-color" content="#0a3d91">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SMessage Chat</title>

  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <script src="/socket.io/socket.io.js"></script>
  <script src="/crypto-js/crypto-js.js"></script>
</head>

<body class="sm-page-bg">

  <!-- CHAT WRAPPER -->
  <main class="sm-chat-wrap">

    <!-- HEADER WITH TIMER + ROOM ID + QUIT -->
    <header class="sm-chat-header" role="banner">
      <div>
        <div class="sm-chat-title">Private Chat Room</div>
        <div class="sm-chat-sub">End-to-end encrypted</div>
      </div>

      <div style="display:flex; align-items:center; gap:12px;">
        <div class="sm-room-meta" style="margin-right:6px;">
          <span id="roomIdBox" class="sm-room-id"></span>
          <span id="timerBox" class="sm-timer">00:00</span>
        </div>

        <!-- Quit button (small, visible) -->
        <button id="quitBtn"
                class="sm-btn"
                style="padding:8px 12px; font-size:0.92rem; border-radius:10px; background:#ffffff; color:#0a53c9; box-shadow:none;">
          Quit
        </button>
      </div>
    </header>

    <!-- CHAT CARD -->
    <section class="sm-chat-card" role="main" aria-live="polite">

      <!-- TYPING INDICATOR -->
      <div id="typingIndicator"
           style="font-size:0.85rem;color:#6c84c5;display:none;text-align:center">
        Friend is typingâ€¦
      </div>

      <!-- MESSAGES -->
      <div id="messages" class="sm-messages" aria-live="polite" aria-atomic="false"></div>

      <!-- INPUT ROW -->
      <div class="sm-input-row" role="form" aria-label="Send message">
        <button id="emojiBtn" class="sm-emoji-btn" aria-label="Open emoji panel">ğŸ˜Š</button>
        <input id="messageInput" class="sm-message-input" type="text" placeholder="Type a message..." autocomplete="off" />
        <button id="sendBtn" class="sm-send-btn" aria-label="Send">Send</button>
      </div>

    </section>

    <div class="sm-chat-note">Temporary encrypted room. No messages are stored.</div>

  </main>

  <!-- EMOJI PANEL -->
  <div id="emojiPanel"
       style="display:none; position:fixed; bottom:90px; left:20px;
              background:#fff; border:1px solid #d7e1f5;
              padding:10px; border-radius:10px;
              box-shadow:0px 12px 28px rgba(0,0,0,0.15); z-index:200;">
    <div style="display:flex;flex-wrap:wrap;gap:8px;width:230px;">
      <button class="emoji" style="background:none;border:none;font-size:22px;cursor:pointer">ğŸ˜€</button>
      <button class="emoji" style="background:none;border:none;font-size:22px;cursor:pointer">ğŸ˜‚</button>
      <button class="emoji" style="background:none;border:none;font-size:22px;cursor:pointer">ğŸ˜</button>
      <button class="emoji" style="background:none;border:none;font-size:22px;cursor:pointer">ğŸ˜®</button>
      <button class="emoji" style="background:none;border:none;font-size:22px;cursor:pointer">ğŸ˜¢</button>
      <button class="emoji" style="background:none;border:none;font-size:22px;cursor:pointer">ğŸ‘</button>
      <button class="emoji" style="background:none;border:none;font-size:22px;cursor:pointer">ğŸ™</button>
      <button class="emoji" style="background:none;border:none;font-size:22px;cursor:pointer">ğŸ”¥</button>
    </div>
  </div>

  <!-- FOOTER -->
  <footer style="text-align:center;margin-top:14px;">
    <a href="privacy.html" style="color:#ffffff;">Privacy Policy</a> â€¢
    <a href="terms.html" style="color:#ffffff;">Terms</a>
  </footer>

<script>
(() => {
    const socket = io();

    const params = new URLSearchParams(window.location.search);
    const roomId = params.get("room");
    const secretKey = params.get("key");
    const expireAt = Number(params.get("expireAt"));

    const messagesDiv = document.getElementById("messages");
    const input = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");
    const timerBox = document.getElementById("timerBox");
    const typingIndicator = document.getElementById("typingIndicator");
    const emojiBtn = document.getElementById("emojiBtn");
    const emojiPanel = document.getElementById("emojiPanel");
    const quitBtn = document.getElementById("quitBtn");

    document.getElementById("roomIdBox").textContent = `Room: ${roomId}`;

    // NAME HANDLING
    let myName = localStorage.getItem("blinkchat_name");
    if (!myName) {
        myName = prompt("Enter your name:")?.trim() || "Anonymous";
        localStorage.setItem("blinkchat_name", myName);
    }

    socket.emit("joinRoom", { roomId, name: myName });

    // TIMER
    const timerInterval = setInterval(() => {
        const diff = expireAt - Date.now();
        if (diff <= 0) {
            timerBox.textContent = "Expired";
            socket.emit("quitRoom", roomId);
            clearInterval(timerInterval);
            return setTimeout(() => (window.location.href = "/"), 1500);
        }

        const m = Math.floor(diff / 60000);
        const s = Math.floor((diff % 60000) / 1000);
        timerBox.textContent = `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
    }, 1000);

    // TYPING
    let typingTimer;
    input.addEventListener("input", () => {
        socket.emit("typing", roomId);
        clearTimeout(typingTimer);
        typingTimer = setTimeout(() => socket.emit("stopTyping", roomId), 1200);
    });

    socket.on("showTyping", () => {
        typingIndicator.style.display = "block";
        clearTimeout(typingIndicator._hide);
        typingIndicator._hide = setTimeout(() => {
            typingIndicator.style.display = "none";
        }, 1500);
    });

    socket.on("hideTyping", () => {
        typingIndicator.style.display = "none";
    });

    // EMOJI PANEL
    emojiBtn.addEventListener("click", () => {
        emojiPanel.style.display = emojiPanel.style.display === "none" ? "block" : "none";
    });

    emojiPanel.addEventListener("click", (e) => {
        if (e.target.classList.contains("emoji")) {
            input.value += e.target.textContent;
            input.focus();
        }
    });

    // SEND MESSAGE
    function sendMessage() {
        const msg = input.value.trim();
        if (!msg) return;

        // encrypt + send
        const encrypted = CryptoJS.AES.encrypt(msg, secretKey).toString();
        socket.emit("sendMessage", { roomId, message: encrypted });

        addMessage(myName + " (You)", msg, "right");
        input.value = "";
    }

    sendBtn.addEventListener("click", sendMessage);
    input.addEventListener("keydown", (e) => e.key === "Enter" && sendMessage());

    // RECEIVE MESSAGE
    socket.on("newMessage", ({ message, from }) => {
        try {
            const decrypted = CryptoJS.AES.decrypt(message, secretKey).toString(CryptoJS.enc.Utf8);
            addMessage(from || "Friend", decrypted || "[decrypt error]", "left");
        } catch {
            addMessage("System", "[Decryption error]", "center");
        }
    });

    socket.on("systemMessage", (msg) => {
        addMessage("System", msg, "center");
    });

    function addMessage(name, text, side) {
        const div = document.createElement("div");
        div.className = `sm-msg ${side}`;

        if (side !== "center") {
            const tag = document.createElement("div");
            tag.style.cssText = "font-size:0.7rem;margin-bottom:4px;color:#6c84c5;";
            tag.textContent = name;
            div.appendChild(tag);
        }

        const body = document.createElement("div");
        body.style.whiteSpace = 'pre-wrap';
        body.textContent = text;
        div.appendChild(body);

        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // QUIT button behavior
    quitBtn.addEventListener("click", () => {
      if (!confirm("Leave this chat room now?")) return;

      // ask whether to remove saved name
      const removeName = confirm("Also remove your saved display name from this device?");
      if (removeName) localStorage.removeItem("blinkchat_name");

      // emit quit and go home
      socket.emit("quitRoom", roomId);
      window.location.href = "/";
    });

})();
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="theme-color" content="#0a3d91">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SMessage</title>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />
</head>

<body class="sm-page-bg">
  <main class="sm-center-wrap">
    <section class="sm-app-card" role="region" aria-labelledby="app-title">
      <header class="sm-card-header">
        <h1 id="app-title" class="sm-app-title">SMessage <span class="sm-bubble">üí¨</span></h1>
        <p class="sm-subtitle">Create a private chat room with one click. No sign-up. End-to-end encrypted.</p>
      </header>

      <!-- Disclaimer -->
      <div class="sm-disclaimer-box">
        <strong>‚ö†Ô∏è Disclaimer:</strong> SMessage provides private encrypted chat rooms. Users are responsible
        for their own messages. Illegal, harmful, or abusive use is strictly prohibited.
      </div>

      <!-- Data Safety -->
      <div class="sm-data-safety" aria-label="Data safety summary">
        <h3>üîê Data Safety Summary</h3>
        <ul>
          <li><strong>No personal data collected.</strong></li>
          <li><strong>No third-party sharing.</strong></li>
          <li><strong>End-to-end encrypted chats.</strong></li>
          <li><strong>Temporary room data only.</strong></li>
          <li><strong>No ads or third-party SDKs.</strong></li>
        </ul>
      </div>

      <!-- Buttons -->
      <div class="sm-cta-row">
        <button id="createRoomBtn" class="sm-btn sm-btn-primary sm-big">Create Room</button>
        <button id="openJoinWindowBtn" class="sm-btn sm-btn-outline sm-big">Join Room</button>
      </div>

      <!-- Room link display (dynamic) -->
      <div id="linkDisplay" class="sm-link-display" aria-live="polite"></div>

      <!-- Join popup -->
      <div id="joinRoomPopup" class="sm-modal" role="dialog" aria-modal="true" aria-hidden="true">
        <div class="sm-modal-inner" role="document">
          <h4>Paste Room Link</h4>
          <input id="joinRoomInput" type="text" placeholder="https://example.com/join.html?room=..." />
          <div class="sm-modal-actions">
            <button id="joinRoomSubmit" class="sm-btn sm-btn-primary">Join</button>
            <button id="closeJoinPopup" class="sm-btn sm-btn-ghost">Cancel</button>
          </div>
        </div>
      </div>

      <!-- Footer links + small info -->
      <footer class="sm-card-footer">
        <div class="sm-footer-links">
          <a href="privacy.html">Privacy Policy</a>
          <a href="terms.html">Terms of Service</a>
        </div>

        <div class="sm-footer-note">
          <small>üîí Messages are encrypted in your browser. No one ‚Äî not even us ‚Äî can read them.</small>
        </div>
      </footer>
    </section>
  </main>

  <!-- Socket & Crypto -->
  <script src="/crypto-js/crypto-js.js"></script>
  <script src="/socket.io/socket.io.js"></script>

  <!-- App logic -->
  <script>
    const socket = io();
    const createBtn = document.getElementById('createRoomBtn');
    const linkDisplay = document.getElementById('linkDisplay');

    // Create room
    createBtn.addEventListener('click', () => {
      createBtn.disabled = true;
      createBtn.textContent = 'Creating Room...';
      socket.emit('createRoom');
    });

    socket.on('roomCreated', ({ roomId, expireAt }) => {
      createBtn.disabled = false;
      createBtn.textContent = 'Create Room';

      const secretKey = CryptoJS.lib.WordArray.random(16).toString();
      const link = `${window.location.origin}/join.html?room=${roomId}&key=${secretKey}&expireAt=${expireAt}`;

      linkDisplay.innerHTML = `
        <div class="sm-link-box">
          <div class="sm-link-label">Share this link with your friend:</div>
          <div class="sm-link-row">
            <input id="roomLinkInput" class="sm-link-input" type="text" value="${link}" readonly />
            <button id="copyBtn" class="sm-btn sm-btn-copy">Copy</button>
          </div>
          <div class="sm-meta">
            <span>Room expires at: ${new Date(expireAt).toLocaleTimeString()}</span>
            <span id="countdown" class="sm-countdown"></span>
          </div>
          <div id="copyStatus" class="sm-copy-status" aria-hidden="true">‚úî Copied!</div>
        </div>
      `;

      // countdown (40s redirect to join page)
      let countdown = 40;
      const countdownEl = document.getElementById('countdown');
      if (countdownEl) countdownEl.textContent = ` ‚Ä¢ Redirecting in ${countdown}s`;

      const t = setInterval(() => {
        countdown--;
        if (countdownEl) countdownEl.textContent = ` ‚Ä¢ Redirecting in ${countdown}s`;
        if (countdown <= 0) {
          clearInterval(t);
          window.location.href = `/join.html?room=${roomId}&key=${secretKey}&expireAt=${expireAt}`;
        }
      }, 1000);
    });

    // Copy handler (delegated because linkDisplay is dynamic)
    document.addEventListener('click', (e) => {
      if (e.target && e.target.id === 'copyBtn') {
        const linkInput = document.getElementById('roomLinkInput');
        const copyStatus = document.getElementById('copyStatus');
        if (!linkInput) return;

        // select + clipboard
        linkInput.select();
        linkInput.setSelectionRange(0, 99999);

        navigator.clipboard.writeText(linkInput.value)
          .then(() => {
            if (copyStatus) {
              copyStatus.style.opacity = '1';
              copyStatus.setAttribute('aria-hidden', 'false');
              setTimeout(() => {
                if (copyStatus) {
                  copyStatus.style.opacity = '0';
                  copyStatus.setAttribute('aria-hidden', 'true');
                }
              }, 1500);
            }
          })
          .catch(() => alert('Failed to copy link'));
      }
    });

    // Join modal controls
    const joinBtnOpen = document.getElementById('openJoinWindowBtn');
    const joinPopup = document.getElementById('joinRoomPopup');
    const joinSubmit = document.getElementById('joinRoomSubmit');
    const joinInput = document.getElementById('joinRoomInput');
    const closeJoinPopup = document.getElementById('closeJoinPopup');

    function openJoin() {
      joinPopup.style.display = 'grid';
      joinPopup.setAttribute('aria-hidden', 'false');
      setTimeout(() => joinInput.focus(), 60);
    }
    function closeJoin() {
      joinPopup.style.display = 'none';
      joinPopup.setAttribute('aria-hidden', 'true');
      joinInput.value = '';
    }

    joinBtnOpen.addEventListener('click', openJoin);
    closeJoinPopup.addEventListener('click', closeJoin);

    joinSubmit.addEventListener('click', () => {
      const link = joinInput.value.trim();
      if (!link) return alert('Please paste a valid link');
      try {
        const url = new URL(link);
        window.location.href = url.href;
      } catch {
        alert('Invalid room link!');
      }
    });

    // close modal on outside click
    joinPopup.addEventListener('click', (ev) => {
      if (ev.target === joinPopup) closeJoin();
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="theme-color" content="#0a3d91">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SMessage</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />
</head>

<body class="sm-page-bg">
  <main class="sm-center-wrap">
    <section class="sm-app-card" role="region" aria-labelledby="app-title">
      <header class="sm-card-header">
        <h1 id="app-title" class="sm-app-title">SMessage <span class="sm-bubble">ðŸ’¬</span></h1>
        <p class="sm-subtitle">Secure temporary chat rooms. No sign-up. End-to-end encrypted.</p>
      </header>

      <div class="sm-logo-container">
        <img src="SMessage.png" alt="SMessage Logo" class="sm-logo-img">
      </div>

      <div class="sm-cta-row">
        <button id="createRoomBtn" class="sm-btn sm-btn-primary sm-big">Create Room</button>
        <button id="openJoinWindowBtn" class="sm-btn sm-btn-outline sm-big">Join Room</button>
      </div>

      <div id="linkDisplay" class="sm-link-display" aria-live="polite"></div>

      <div id="joinRoomPopup" class="sm-modal" role="dialog" aria-modal="true" aria-hidden="true">
        <div class="sm-modal-inner" role="document">
          <h4>Enter Room Passcode</h4>
          <p style="font-size: 0.8rem; color: #666; margin-bottom: 10px;">Ask your friend for their 6-digit code.</p>
          <input id="joinRoomInput" type="number" placeholder="000000" 
                 style="text-align: center; font-size: 1.5rem; letter-spacing: 8px;"
                 oninput="if(this.value.length > 6) this.value = this.value.slice(0, 6);" />
          
          <div class="sm-modal-actions">
            <button id="joinRoomSubmit" class="sm-btn sm-btn-primary">Connect</button>
            <button id="closeJoinPopup" class="sm-btn sm-btn-ghost">Cancel</button>
          </div>
        </div>
      </div>
      
      <div id="termsModal" class="sm-modal" role="dialog" aria-modal="true" aria-hidden="true">
        <div class="sm-modal-inner" role="document" style="max-width: 500px;">
          <h4>SMessage Terms & Conditions</h4>
          <div style="height: 180px; overflow-y: scroll; padding: 10px; border: 1px solid #ddd; font-size: 0.85rem; line-height: 1.4;">
            <p>By using SMessage, you agree to these Terms of Service. All messages are temporary and deleted upon room expiration.</p>
            <p style="margin-top: 10px;">Please read the full <a href="terms.html" target="_blank" style="color:#0a53c9;">Terms of Service</a> and <a href="privacy.html" target="_blank" style="color:#0a53c9;">Privacy Policy</a>.</p>
          </div>
          <div style="display: flex; align-items: center; gap: 10px; margin-top: 15px;">
            <input type="checkbox" id="acceptTermsCheckbox" style="width: 20px; height: 20px; margin: 0;">
            <label for="acceptTermsCheckbox" style="font-size: 0.95rem; color: #333;">I agree to the Terms & Conditions.</label>
          </div>
          <button id="agreeAndContinueBtn" class="sm-btn" disabled style="margin-top: 10px; width: 100%; opacity: 0.5;">Agree and Continue</button>
        </div>
      </div>

      <footer class="sm-card-footer">
        <div class="sm-footer-links">
          <a href="privacy.html">Privacy Policy</a>
          <a href="terms.html">Terms of Service</a>
        </div>
        <div class="sm-footer-note">
          <small>ðŸ”’ Passcodes link you to encrypted sessions. No data is stored on our servers.</small>
        </div>
      </footer>
    </section>
  </main>

  <script src="crypto-js/crypto-js.js"></script>
  <script src="https://blinkchat-i72t.onrender.com/socket.io/socket.io.js"></script>

<script>
window.addEventListener("load", () => {

  const socket = io("https://blinkchat-i72t.onrender.com", {
    transports: ["websocket", "polling"]
  });

  const linkDisplay = document.getElementById('linkDisplay');
  const createBtn = document.getElementById('createRoomBtn');

  // 1. Create room logic
  createBtn.addEventListener('click', () => {
    if (createBtn.disabled) return;
    createBtn.disabled = true;
    createBtn.textContent = 'Generating Code...';
    socket.emit('createRoom');
  });

  socket.on('roomCreated', ({ passcode, roomId, expireAt }) => {
    createBtn.disabled = false;
    createBtn.textContent = 'Create Room';

    // FIX: Generate key BASED on the passcode so User 2 can recreate it locally
    const secretKey = CryptoJS.SHA256(passcode).toString();
    
    // Save for persistence (Syncing User 1)
    localStorage.setItem('last_room_id', roomId); 
    localStorage.setItem('last_passcode', passcode);
    localStorage.setItem('last_secret_key', secretKey);
    localStorage.setItem('last_expire_at', expireAt);

    linkDisplay.innerHTML = `
      <div class="sm-link-box" style="text-align: center;">
        <div class="sm-link-label">Your 6-Digit Passcode:</div>
        <div style="font-size: 2.5rem; font-weight: bold; color: #0a3d91; letter-spacing: 5px; margin: 15px 0;">
          ${passcode}
        </div>
        <div class="sm-meta">
          <span>Give this code to your friend</span><br>
          <span id="countdown" class="sm-countdown"></span>
        </div>
      </div>
    `;

    let countdown = 15;
    const countdownEl = document.getElementById('countdown');
    const t = setInterval(() => {
      countdown--;
      if (countdownEl) {
        countdownEl.textContent = ` â€¢ Redirecting to chat in ${countdown}s`;
      }

      if (countdown <= 0) {
        clearInterval(t);
        // Redirect with all 3 critical keys: Hex ID, Passcode, and Derived AES Key
        window.location.href = `join.html?room=${roomId}&p=${passcode}&key=${secretKey}&expireAt=${expireAt}`;
      }
    }, 1000);
  });

  // 2. Join room logic
  const joinBtnOpen = document.getElementById('openJoinWindowBtn');
  const joinRoomPopup = document.getElementById('joinRoomPopup');
  const joinSubmit = document.getElementById('joinRoomSubmit');
  const joinInput = document.getElementById('joinRoomInput');
  const closeJoinPopup = document.getElementById('closeJoinPopup');

  joinBtnOpen.addEventListener('click', () => {
    joinRoomPopup.classList.add('sm-modal-open');
    setTimeout(() => joinInput.focus(), 50); 
  });

  closeJoinPopup.addEventListener('click', () => {
    joinRoomPopup.classList.remove('sm-modal-open');
  });

  joinSubmit.addEventListener('click', () => {
    const passcode = joinInput.value.trim();
    if (passcode.length !== 6) return alert('Please enter a 6-digit passcode');
    joinSubmit.disabled = true;
    joinSubmit.textContent = "Connecting...";
    socket.emit('joinRoom', { passcode: passcode });
  });

  socket.on('joinSuccess', ({ roomId, passcode, expireAt }) => {
      // For the Joiner, the key is derived from the passcode in join.html
      window.location.href = `join.html?room=${roomId}&p=${passcode}&expireAt=${expireAt}`;
  });

  socket.on('systemMessage', (msg) => {
      if (msg.includes("Invalid") || msg.includes("expired") || msg.includes("full")) {
          alert(msg);
          joinSubmit.disabled = false;
          joinSubmit.textContent = "Connect";
      }
  });

  // T&C logic
  const termsModal = document.getElementById('termsModal');
  const acceptTermsCheckbox = document.getElementById('acceptTermsCheckbox');
  const agreeAndContinueBtn = document.getElementById('agreeAndContinueBtn');

  if (!localStorage.getItem('sm_terms_accepted')) {
      termsModal.classList.add('sm-modal-open');
  }

  acceptTermsCheckbox.addEventListener('change', () => {
      agreeAndContinueBtn.disabled = !acceptTermsCheckbox.checked;
      agreeAndContinueBtn.style.opacity = acceptTermsCheckbox.checked ? 1 : 0.5;
  });

  agreeAndContinueBtn.addEventListener('click', () => {
      localStorage.setItem('sm_terms_accepted', 'true');
      termsModal.classList.remove('sm-modal-open');
  });
});
</script>
</body>
</html>
